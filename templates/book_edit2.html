<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ book_title }} - Edit</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}">
    
</head>

<body>
    <div class="container">
        <header>
            <a href="/" class="back-link">← Back to Home</a>
            <h1>{{ book_title }}</h1>
            <div class="header-actions">
                <button id="settings-toggle">⚙️</button>
                <button id="toc-toggle">☰</button>
            </div>
        </header>

        <div class="sidebar" id="toc-sidebar">
            <h2>Table of Contents</h2>
            <ul>
                {% for heading in toc %}
                <li style="margin-left: {{ (heading.level - 1) * 20 }}px;">
                    <a href="#para-{{ heading.para_id }}">{{ heading.title }} ({{ heading.para_count }} paragraphs)</a>
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="content" id="content">
            <!-- Content will be loaded dynamically -->
        </div>

        <div class="settings-panel" id="settings-panel">
            <h2>Settings</h2>
            <div class="settings-option">
                <label>View Mode</label>
                <div>
                    <input type="radio" name="view-mode" value="horizontal" checked> Horizontal
                    <input type="radio" name="view-mode" value="vertical"> Vertical
                </div>
            </div>
            <button id="settings-close">Close</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bookId = '{{ book_id }}';
            const tocLinks = document.querySelectorAll('.sidebar a');
            const contentDiv = document.getElementById('content');

            async function loadParagraph(paraId) {
                const response = await fetch(`/book_edit/${bookId}/${paraId}`);
                const sentences = await response.json();

                // Clear existing content
                contentDiv.innerHTML = '';

                // Group sentences by para_id
                const paragraphs = {};
                sentences.forEach(sentence => {
                    if (!paragraphs[sentence.para_id]) {
                        paragraphs[sentence.para_id] = [];
                    }
                    paragraphs[sentence.para_id].push(sentence);
                });

                // Create accordion for each paragraph
                for (const paraId in paragraphs) {
                    const accordion = document.createElement('div');
                    accordion.className = 'accordion';
                    accordion.id = `para-${paraId}`;

                    const paraHeader = document.createElement('h3');
                    paraHeader.textContent = `Paragraph ${paraId}`;

                    // Create container for header and buttons
                    const headerContainer = document.createElement('div');
                    headerContainer.style.display = 'flex';
                    headerContainer.style.alignItems = 'center';

                    // Add buttons for Aṭṭhakathā/Tīkā/Mūla
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.style.marginLeft = '10px';

                    // Fetch related paragraph IDs
                    fetch(`/get_related_para/${bookId}/${paraId}`)
                        .then(response => response.json())
                        .then(data => {
                            const bookType = bookId.endsWith('m.mul') ? 'mul' : bookId.endsWith('a.att') ? 'att' : bookId.endsWith('t.tik') ? 'tik' : null;
                            if (bookType) {
                                if (bookType !== 'mul' && data.mul_para_id) {
                                    const mulButton = document.createElement('button');
                                    mulButton.textContent = 'Mūla';
                                    mulButton.onclick = () => window.open(`/book_edit/${bookId.replace(/(m.mul|a.att|t.tik)$/, 'm.mul')}#para-${data.mul_para_id}`, '_blank');
                                    buttonsContainer.appendChild(mulButton);
                                }
                                if (bookType !== 'att' && data.att_para_id) {
                                    const attButton = document.createElement('button');
                                    attButton.textContent = 'Aṭṭhakathā';
                                    attButton.onclick = () => window.open(`/book_edit/${bookId.replace(/(m.mul|a.att|t.tik)$/, 'a.att')}#para-${data.att_para_id}`, '_blank');
                                    buttonsContainer.appendChild(attButton);
                                }
                                if (bookType !== 'tik' && data.tik_para_id) {
                                    const tikButton = document.createElement('button');
                                    tikButton.textContent = 'Tīkā';
                                    tikButton.onclick = () => window.open(`/book_edit/${bookId.replace(/\.(m.mul|a.att|t.tik)$/, 't.tik')}#para-${data.tik_para_id}`, '_blank');
                                    buttonsContainer.appendChild(tikButton);
                                }
                            }
                        });

                    headerContainer.appendChild(paraHeader);
                    headerContainer.appendChild(buttonsContainer);
                    accordion.appendChild(headerContainer);

                    const accordionContent = document.createElement('div');
                    accordionContent.className = 'accordion-content';

                    paragraphs[paraId].forEach(sentence => {
                        const sentenceDiv = document.createElement('div');
                        sentenceDiv.className = 'sentence';
                        sentenceDiv.innerHTML = `
                            <p><strong>Pali:</strong> ${sentence.pali}</p>
                            <p><strong>Vietnamese:</strong> <span class="editable" contenteditable="true" data-para-id="${sentence.para_id}" data-line-id="${sentence.line_id}">${sentence.vietnamese}</span></p>
                        `;
                        accordionContent.appendChild(sentenceDiv);
                    });

                    accordion.appendChild(accordionContent);
                    contentDiv.appendChild(accordion);
                }

                // Handle accordion toggle
                document.querySelectorAll('.accordion h3').forEach(header => {
                    header.addEventListener('click', () => {
                        const content = header.parentElement.querySelector('.accordion-content');
                        content.style.display = content.style.display === 'none' ? 'block' : 'none';
                    });
                });

                // Handle editable content
                document.querySelectorAll('.editable').forEach(span => {
                    span.addEventListener('blur', async () => {
                        const paraId = span.dataset.paraId;
                        const lineId = span.dataset.lineId;
                        const vietnamese = span.innerHTML;
                        await fetch('/save_translation', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                book_id: bookId,
                                para_id: paraId,
                                line_id: lineId,
                                vietnamese_sentence: vietnamese
                            })
                        });
                    });
                });
            }

            // Load the first paragraph or the one from URL hash
            const hash = window.location.hash;
            const initialPara = hash ? hash.replace('#para-', '') : '{{ toc[0].para_id }}';
            loadParagraph(initialPara);

            // Handle TOC clicks
            tocLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const paraId = link.getAttribute('href').replace('#para-', '');
                    loadParagraph(paraId);
                    window.location.hash = `para-${paraId}`;
                });
            });

            // Handle settings toggle
            document.getElementById('settings-toggle').addEventListener('click', () => {
                document.getElementById('settings-panel').style.display = 'block';
            });

            document.getElementById('settings-close').addEventListener('click', () => {
                document.getElementById('settings-panel').style.display = 'none';
            });

            // Handle view mode
            document.querySelectorAll('input[name="view-mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    contentDiv.className = `content ${e.target.value}`;
                });
            });

            // Handle TOC toggle
            document.getElementById('toc-toggle').addEventListener('click', () => {
                const sidebar = document.getElementById('toc-sidebar');
                sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
            });
        });
    </script>
</body>

</html>