<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ book_title }} - Chaṭṭha Saṅgāyana Tipiṭaka</title>
    <script src="{{ url_for('static', filename='js/tailwind-3.4.17.js') }}"></script>
    <script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/autocomplete-theme-classic.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        @font-face {
      font-family: 'Segoe UI';
      src: local('Inter'), local('Arial'), sans-serif;
      font-weight: 400;
    }
    </style>
    <style>
        .toc-menu {
            position: fixed;
            top: 56px;
            left: 0;
            height: calc(100vh - 56px);
            width: 0;
            min-width: 0;
            max-width: 500px;
            background: #fff;
            border-right: 1px solid #e5e7eb;
            padding: 1rem 0;
            overflow-y: auto;
            transition: width 0.2s ease;
            z-index: 1000;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.03);
        }

        .toc-menu.open {
            width: 500px;
            min-width: 200px;
            padding: 1rem;
        }

        .content-container {
            margin-left: 0;
            transition: margin-left 0.2s ease;
        }

        @media (min-width: 768px) {
            .toc-menu {
                /* Always collapsed by default */
            }

            .toc-menu.open~.content-container {
                /* margin-left: 260px; */
            }
        }

        .toc-level-1 {
            font-size: 1.2rem;
            font-weight: bold;
            margin-left: 0;
        }

        .toc-level-2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .toc-level-3 {
            font-size: 1rem;
            margin-left: 1rem;
        }

        .toc-level-4 {
            font-size: 0.95rem;
            margin-left: 1.5rem;
        }

        .toc-level-5 {
            font-size: 0.9rem;
            margin-left: 2rem;
        }

        .toc-level-6 {
            font-size: 0.85rem;
            margin-left: 2.5rem;
        }

        .para-group {
            border-left: 2px solid #d1d5db;
            padding-left: 1rem;
            margin-bottom: 1rem;
        }

        .pali-text {
            color: maroon;
        }

        .trans-text {
            color: darkblue;
        }

        .trans2-text {
            color: darkblue;
        }

        .joined-text {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #settings-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        #settings-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-field {
            margin-bottom: 1.5rem;
        }

        .modal-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .modal-field input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .modal-field input[type="radio"] {
            margin-right: 0.5rem;
        }

        .modal-field input[type="color"] {
            width: 50px;
            height: 30px;
            padding: 2px;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            cursor: pointer;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        sup {
          vertical-align: super;
          font-size: 0.75em;
          line-height: 1;
          position: relative;
          top: -0.5em;
          color: #666;
          /*background: #f0f0f0;*/
          border-radius: 50%;
          width: 1.2em;
          height: 1.2em;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          cursor: help;
          transition: all 0.2s ease;
        }

        sup:hover {
          color: #000;
          background: #e0e0e0;
          transform: scale(1.1);
        }

        sup::after {
          content: attr(title);
          position: absolute;
          bottom: 100%;
          left: 50%;
          transform: translateX(-50%);
          background: #333;
          color: #fff;
          padding: 0.5em 0.75em;
          border-radius: 4px;
          font-size: 0.85em;
          white-space: nowrap;
          opacity: 0;
          visibility: hidden;
          transition: opacity 0.2s ease;
          margin-bottom: 0.25em;
          z-index: 10;
        }

        sup:hover::after {
          opacity: 1;
          visibility: visible;
        }

        sup::before {
          content: '';
          position: absolute;
          top: 100%;
          left: 50%;
          transform: translateX(-50%);
          border: 0.4em solid transparent;
          border-top-color: #333;
          opacity: 0;
          visibility: hidden;
          transition: opacity 0.2s ease;
        }

        sup:hover::before {
          opacity: 1;
          visibility: visible;
        }
    </style>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7NQWX1DCC2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-7NQWX1DCC2');
</script>

<body class="bg-amber-50 text-gray-800 font-sans">
    <div id="toc-menu" class="toc-menu">
        <h2 class="text-xl font-semibold mb-2">Table of Contents</h2>
        <input id="toc-search" type="text" placeholder="Search TOC..." class="w-full p-2 mb-4 border rounded">
        <ul id="toc-list">
            {% for heading in toc %}
            <li class="toc-level-{{ heading.level }}"><a href="{{ heading.url }}" class="text-blue-600 hover:underline flex justify-between py-1 toc-link" data-para-id="{{ heading.para_id }}">
                    <span>{{ heading.title }}</span>
                    <span>{{ heading.para_id }}</span>
                </a></li>
            {% endfor %}
        </ul>
    </div>
    <div class="content-container container mx-auto p-4" id="content-container">
        <div class="w-full flex items-center justify-between bg-white shadow px-4 py-2 fixed top-0 left-0 z-50" style="height:56px;">
            <div class="flex items-center space-x-4">
                <button id="toggle-toc" class="text-blue-600 hover:underline text-xl" aria-label="Toggle Table of Contents">☰</button>
                <a href="{{ base_url }}" class="text-blue-600 hover:underline text-lg" style="font-family: 'Noto Sans Symbols2', 'Segoe UI Symbol', sans-serif;">⮲</a>
            </div>
            <h1 class="text-xl text-sm:sm font-bold text-center flex-1 truncate">{{ book_title }}</h1>
            <div class="flex items-center space-x-2">
                {% if bookref.mula_ref %}
                <a href="{{ base_url }}/book_ref/{{ bookref.mula_ref }}?ref={{ book_id }}" class="text-blue-600 hover:underline text-sm font-semibold px-2 py-1 rounded bg-blue-100">Mula</a>
                {% endif %}
                {% if bookref.attha_ref %}
                <a href="{{ base_url }}/book_ref/{{ bookref.attha_ref }}?ref={{ book_id }}" class="text-blue-600 hover:underline text-sm font-semibold px-2 py-1 rounded bg-blue-100">Attha</a>
                {% endif %}
                {% if bookref.tika_ref %}
                <a href="{{ base_url }}/book_ref/{{ bookref.tika_ref }}?ref={{ book_id }}" class="text-blue-600 hover:underline text-sm font-semibold px-2 py-1 rounded bg-blue-100">Tika</a>
                {% endif %}
                <button id="settings-btn" class="text-blue-600 hover:underline text-sm">Settings</button>
                <a class="text-red-600 hover:underline text-sm font-semibold ml-2 px-2 py-1 rounded bg-blue-100" id="edit_button" href="{{ edit_url }}">Edit</a>
            </div>
        </div>
        <div style="height:56px;"></div>
        {% if sentences %}
        {% for sentence in sentences %}
        {% set outer_loop = loop %}
        {% set current_para = sentence[0] %}
        {% set is_first_in_para = (loop.first or sentences[loop.index0-1][0] != current_para) %}
        {% set is_last_in_para = (loop.last or sentences[loop.index0+1][0] != current_para) %}
        {% if is_first_in_para %}
        <div class="para-group" id="para-{{ current_para }}">
            <div class="flex items-center justify-between relative">
                <div></div>
                <span class="absolute top-0 left-[-2rem] bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full shadow paraId" style="z-index:1;">
                    {{ current_para }}
                </span>
            </div>
            {% endif %}
            <div id="sentence-{{ sentence[0] }}-{{ sentence[1] }}" class="mb-2">
                <div class="pali-text">{{ sentence[2]|safe }}</div>
                <div class="trans-text">{{ sentence[3] | safe }}</div>
                <div class="trans2-text">{{ sentence[4] | safe }}</div>
            </div>
            {% if is_last_in_para %}
        </div>
        {% endif %}
        {% endfor %}
        {% else %}
        <ul id="toc-list-main" class="list-none p-0">
            {% for heading in toc %}
            <li class="toc-level-{{ heading.level }}"><a href="{{ heading.url }}" class="text-blue-600 hover:underline flex justify-between py-1 toc-link" data-para-id="{{ heading.para_id }}">
                    <span>{{ heading.title }}</span>
                    <span>{{ heading.para_id }}</span>
                </a></li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    <div id="settings-modal">
        <div class="modal-content">
            <h2 class="text-lg font-semibold mb-4">Settings</h2>
            <form id="settings-form">
                <div class="modal-field">
                    <label>Display</label>
                    <label><input type="checkbox" id="pali-cb" name="pali"> Pali</label>
                    <label><input type="checkbox" id="english-cb" name="english"> English</label>
                    <label><input type="checkbox" id="vietnamese-cb" name="vietnamese"> Vietnamese</label>
                </div>
                <div class="modal-field">
                    <label>Search Method</label>
                    <label><input type="radio" name="search" value="fts" required> Full-Text Search (FTS)</label>
                    <label><input type="radio" name="search" value="ai"> AI Index Search</label>
                </div>
                <div class="modal-field">
                    <label>Pali Text Color</label>
                    <input type="color" name="paliColor" value="#800000">
                </div>
                <div class="modal-field">
                    <label>English Text Color</label>
                    <input type="color" name="trans1Color" value="#00008b">
                </div>
                <div class="modal-field">
                    <label>Vietnamese Text Color</label>
                    <input type="color" name="trans2Color" value="#00008b">
                </div>
                <div class="modal-field">
                    <label>Background Color</label>
                    <input type="color" name="bgColor" value="#fef3c7">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn" id="cancel-btn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
    <script>
    const toggleBtn = document.getElementById('toggle-toc');
    const tocMenu = document.getElementById('toc-menu');
    const searchInput = document.getElementById('toc-search');
    const tocList = document.getElementById('toc-list');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const settingsForm = document.getElementById('settings-form');
    const cancelBtn = document.getElementById('cancel-btn');

    document.currentParaId = 'para-1';

    document.addEventListener('click', function(event) {
        if (
            tocMenu.classList.contains('open') &&
            !tocMenu.contains(event.target) &&
            !toggleBtn.contains(event.target)
        ) {
            tocMenu.classList.remove('open');
        }
    });
    tocMenu.classList.remove('open');

    document.querySelectorAll('#toc-list a').forEach(link => {
        link.classList.remove('bg-yellow-200');
    });

    toggleBtn.addEventListener('click', (e) => {
        e.preventDefault();
        tocMenu.classList.toggle('open');

        if (tocMenu.classList.contains('open')) {
            const currentParaId = parseInt(document.currentParaId.split('-')[1]);
            const closestHeading = Array.from(document.querySelectorAll('#toc-list a'))
                .filter(a => parseInt(a.getAttribute('href').split('-')[1]) <= currentParaId)
                .pop();
            if (closestHeading) {
                document.querySelectorAll('#toc-list a').forEach(link => {
                    link.classList.remove('bg-yellow-200');
                });
                closestHeading.classList.add('bg-yellow-200');
                // Wait for TOC transition to complete
                setTimeout(() => {
                    const offset = closestHeading.offsetTop - (tocMenu.clientHeight / 2) + (closestHeading.offsetHeight / 2) - 16; // Adjust for padding
                    tocMenu.scrollTo({
                        top: Math.max(0, offset),
                        behavior: 'smooth'
                    });
                }, 200); // Match transition duration (0.2s)
            }
        }
    });

    updateScroll = () => {
        const paraGroups = document.querySelectorAll('.para-group');
        let currentParaId = '';

        for (const para of paraGroups) {
            const rect = para.getBoundingClientRect();
            if (rect.top >= 0 && rect.top <= window.innerHeight / 2) {
                currentParaId = para.id;
                document.currentParaId = currentParaId;
                break;
            }
        }

        if (currentParaId) {
            const newUrl = `${window.location.pathname}#${currentParaId}`;
            history.replaceState(null, '', newUrl);
            let editbtn = document.querySelector('#edit_button');
            editbtn.setAttribute('href', newUrl.replace('/book/', '/book_edit/'));

            const buttons = [
                { ref: '{{ bookref.mula_ref }}', selector: 'a[href*="{{ bookref.mula_ref }}"]' },
                { ref: '{{ bookref.attha_ref }}', selector: 'a[href*="{{ bookref.attha_ref }}"]' },
                { ref: '{{ bookref.tika_ref }}', selector: 'a[href*="{{ bookref.tika_ref }}"]' }
            ];
            buttons.forEach(button => {
                if (button.ref) {
                    const btn = document.querySelector(button.selector);
                    if (btn) {
                        btn.setAttribute('href', '{{ base_url }}/book_ref/' + button.ref + '?ref={{ book_id }}&para_id=' + currentParaId);
                        console.log('{{ base_url }}/book_ref/' + button.ref + '?ref={{ book_id }}&para_id=' + currentParaId);
                    }
                }
            });

            // Update TOC highlight and scroll if open
            if (tocMenu.classList.contains('open')) {
                const currentParaIdNum = parseInt(currentParaId.split('-')[1]);
                const closestHeading = Array.from(document.querySelectorAll('#toc-list a'))
                    .filter(a => parseInt(a.getAttribute('href').split('-')[1]) <= currentParaIdNum)
                    .pop();
                if (closestHeading) {
                    document.querySelectorAll('#toc-list a').forEach(link => {
                        link.classList.remove('bg-yellow-200');
                    });
                    closestHeading.classList.add('bg-yellow-200');
                    const offset = closestHeading.offsetTop - (tocMenu.clientHeight / 2) + (closestHeading.offsetHeight / 2) - 16; // Adjust for padding
                    tocMenu.scrollTo({
                        top: Math.max(0, offset),
                        behavior: 'smooth'
                    });
                }
            }
        }
    };

    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const tocItems = tocList.getElementsByTagName('li');
        Array.from(tocItems).forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });

    const STORAGE_KEY = 'bookSettings';

    function loadSettings() {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        document.getElementById('pali-cb').checked = (saved.pali !== undefined) ? saved.pali : true;
        document.getElementById('english-cb').checked = (saved.english !== undefined) ? saved.english : true;
        document.getElementById('vietnamese-cb').checked = (saved.vietnamese !== undefined) ? saved.vietnamese : false;
        const searchVal = saved.search || 'fts';
        document.querySelector(`input[name="search"][value="${searchVal}"]`).checked = true;
        document.querySelector(`input[name="paliColor"]`).value = saved.paliColor || '#800000';
        document.querySelector(`input[name="trans1Color"]`).value = saved.trans1Color || '#00008b';
        document.querySelector(`input[name="trans2Color"]`).value = saved.trans2Color || '#00008b';
        document.querySelector(`input[name="bgColor"]`).value = saved.bgColor || '#fef3c7';
        window.searchMethod = searchVal;
        updateDisplay({ pali: (saved.pali !== undefined) ? saved.pali : true, english: (saved.english !== undefined) ? saved.english : true, vietnamese: (saved.vietnamese !== undefined) ? saved.vietnamese : false });
        updateColors(saved.paliColor || '#800000', saved.trans1Color || '#00008b', saved.trans2Color || '#00008b', saved.bgColor || '#fef3c7');
    }

    function saveSettings(e) {
        e.preventDefault();
        const settings = {
            pali: document.getElementById('pali-cb').checked,
            english: document.getElementById('english-cb').checked,
            vietnamese: document.getElementById('vietnamese-cb').checked,
            search: document.querySelector('input[name="search"]:checked').value,
            paliColor: document.querySelector('input[name="paliColor"]').value,
            trans1Color: document.querySelector('input[name="trans1Color"]').value,
            trans2Color: document.querySelector('input[name="trans2Color"]').value,
            bgColor: document.querySelector('input[name="bgColor"]').value
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
        window.searchMethod = settings.search;
        updateDisplay({ pali: settings.pali, english: settings.english, vietnamese: settings.vietnamese });
        updateColors(settings.paliColor, settings.trans1Color, settings.trans2Color, settings.bgColor);
        settingsModal.classList.remove('show');
    }

    function updateColors(paliColor, trans1Color, trans2Color, bgColor) {
        document.querySelectorAll('.pali-text').forEach(el => {
            el.style.color = paliColor;
        });
        document.querySelectorAll('.trans-text').forEach(el => {
            el.style.color = trans1Color;
        });
        document.querySelectorAll('.trans2-text').forEach(el => {
            el.style.color = trans2Color;
        });
        document.body.style.backgroundColor = bgColor;
    }

    function updateDisplay(displaySettings) {
        const { pali, english, vietnamese } = displaySettings;
        const count = (pali ? 1 : 0) + (english ? 1 : 0) + (vietnamese ? 1 : 0);
        const paraGroups = document.querySelectorAll('.para-group');
        const isSingle = count === 1;

        paraGroups.forEach(para => {
            const paraIdEl = para.querySelector('.paraId');
            const joined = para.querySelector('.joined-text');
            if (joined) joined.remove();

            const sentences = para.querySelectorAll('div[id^="sentence-"]');

            if (isSingle) {
                paraIdEl.hidden = true;
                let joinedHtml = '';
                let textClass = '';
                if (pali) textClass = 'pali-text';
                else if (english) textClass = 'trans-text';
                else if (vietnamese) textClass = 'trans2-text';

                sentences.forEach(s => {
                    const textDiv = s.querySelector(`.${textClass}`);
                    if (textDiv) {
                        joinedHtml += textDiv.innerHTML + ' ';
                    }
                    const paliEl = s.querySelector('.pali-text');
                    if (paliEl) paliEl.style.display = 'none';
                    const transEl = s.querySelector('.trans-text');
                    if (transEl) transEl.style.display = 'none';
                    const trans2El = s.querySelector('.trans2-text');
                    if (trans2El) trans2El.style.display = 'none';
                    s.style.display = 'none';
                });

                joinedHtml = joinedHtml.trim();
                if (joinedHtml) {
                    const joinedDiv = document.createElement('div');
                    joinedDiv.className = `joined-text ${textClass}`;
                    joinedDiv.innerHTML = joinedHtml;
                    para.appendChild(joinedDiv);
                }
            } else {
                paraIdEl.hidden = false;
                sentences.forEach(s => {
                    s.style.display = '';
                    const paliEl = s.querySelector('.pali-text');
                    if (paliEl) paliEl.style.display = pali ? '' : 'none';
                    const transEl = s.querySelector('.trans-text');
                    if (transEl) transEl.style.display = english ? '' : 'none';
                    const trans2El = s.querySelector('.trans2-text');
                    if (trans2El) trans2El.style.display = vietnamese ? '' : 'none';
                });
            }
        });
    }

    settingsBtn.addEventListener('click', () => settingsModal.classList.add('show'));
    cancelBtn.addEventListener('click', () => settingsModal.classList.remove('show'));
    settingsForm.addEventListener('submit', saveSettings);
    settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) settingsModal.classList.remove('show');
    });



    document.addEventListener('scroll', updateScroll);
    document.addEventListener('DOMContentLoaded', () => {
        const paraGroups = document.querySelectorAll('.para-group');
        if (paraGroups.length > 0) {
            const para = Array.from(paraGroups).filter(it => {
                let rect = it.getBoundingClientRect();
                return (rect.top >= 0 && rect.top < window.innerHeight);
            }).pop();
            if (para) {
                document.currentParaId = para.id;
                let editbtn = document.querySelector('#edit_button');
                const newUrl = `${window.location.pathname}#${para.id}`;
                editbtn.setAttribute('href', newUrl.replace('/book/', '/book_edit/'));
            }
        }
        loadSettings();
    });
    </script>
</body>

</html>